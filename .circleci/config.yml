version: 2

ruby_defaults: &ruby_defaults
  working_directory: ~/repo
  docker:
    - image: circleci/ruby:2.4.2
  environment:
    BUNDLE_PATH: ~/repo/vendor/bundle

jobs:
  dependencies:
    <<: *ruby_defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - rubygems-v1-{{ checksum "Gemfile.lock" }}
            - rubygems-v1-fallback
      - run:
          name: Bundle Install
          command: bundle install
      - save_cache:
          key: rubygems-v1-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

  build:
    <<: *ruby_defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - rubygems-v1-{{ checksum "Gemfile.lock" }}
            - rubygems-v1-fallback
      - run:
          name: Jekyll build
          command: bundle exec jekyll build
      - persist_to_workspace:
          root: ./
          paths:
            - ./_site
            - ./.firebaserc
            - ./firebase.json

  test_html:
    <<: *ruby_defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - rubygems-v1-{{ checksum "Gemfile.lock" }}
            - rubygems-v1-fallback
      - run:
          name: Test
          command: bundle exec rake test_html

  test_files:
    <<: *ruby_defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - rubygems-v1-{{ checksum "Gemfile.lock" }}
            - rubygems-v1-fallback
      - run:
          name: Test
          command: bundle exec rake test_files

  test_posts:
    <<: *ruby_defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - rubygems-v1-{{ checksum "Gemfile.lock" }}
            - rubygems-v1-fallback
      - run:
          name: Test
          command: bundle exec rake test_posts

  download_docs:
    <<: *ruby_defaults
    environment:
      CIRCLE_REPOSITORY_URL: git@github.com:ePages-de/epages-docs.git
      CIRCLE_BRANCH: master
    steps:
      - run: |
          set -e

          # Workaround old docker images with incorrect $HOME
          # check https://github.com/docker/docker/issues/2968 for details
          if [ "${HOME}" = "/" ]
          then
            export HOME=$(getent passwd $(id -un) | cut -d: -f6)
          fi

          mkdir -p ~/.ssh

          echo 'github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
          bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAubiN81eDcafrgMeLzaFPsw2kNvEcqTKl/VqLat/MaB33pZy0y3rJZtnqwR2qOOvbwKZYKiEO1O6VqNEBxKvJJelCq0dTXWT5pbO2gDXC6h6QDXCaHo6pOHGPUy+YBaGQRGuSusMEASYiWunYN0vCAI8QaXnWMXNMdFP3jHAJH0eDsoiGnLPBlBp4TNm6rYI74nMzgz3B9IikW4WVK+dc8KZJZWYjAuORU3jc1c/NPskD2ASinf8v3xnfXeukU0sJ5N6m5E8VLjObPEO+mN2t/FZTMZLiFqPWc/ALSqnMnnhwrNi2rbfg/rd/IpL8Le3pSBne8+seeFVBoGqzHM9yXw==
          ' >> ~/.ssh/known_hosts

          (umask 077; touch ~/.ssh/id_rsa)
          chmod 0600 ~/.ssh/id_rsa
          (cat <<EOF > ~/.ssh/id_rsa
          $CHECKOUT_KEY
          EOF
          )

          # use git+ssh instead of https
          git config --global url."ssh://git@github.com".insteadOf "https://github.com" || true

          if [ -e /home/circleci/repo/.git ]
          then
            cd /home/circleci/repo
            git remote set-url origin "$CIRCLE_REPOSITORY_URL" || true
          else
            mkdir -p /home/circleci/repo
            cd /home/circleci/repo
            git clone "$CIRCLE_REPOSITORY_URL" .
          fi

          if [ -n "$CIRCLE_TAG" ]
          then
            git fetch --force origin "refs/tags/${CIRCLE_TAG}"
          else
            git fetch --force origin "master:remotes/origin/master"
          fi


          if [ -n "$CIRCLE_TAG" ]
          then
            git reset --hard "$CIRCLE_SHA1"
            git checkout -q "$CIRCLE_TAG"
          elif [ -n "master" ]
          then
            git reset --hard "$CIRCLE_SHA1"
            git checkout -q -B "master"
          fi

          git reset --hard "$CIRCLE_SHA1"

  # deploy_firebase:
  #   docker:
  #     - image: circleci/node:6.10.3
  #   steps:
  #     - attach_workspace:
  #         at: ./
  #     - run:
  #         name: Install Firebase tools
  #         command: npm install --save-dev firebase-tools
  #     - run:
  #         name: Deploy to Firebase
  #         command: ./node_modules/.bin/firebase deploy --token=$FIREBASE_TOKEN --non-interactive
  #
  # deploy_aws:
  #   <<: *defaults
  #   environment:
  #     S3_BUCKET_NAME: staging.developer.epages.com
  #   docker:
  #     - image: circleci/python:3.6.3
  #   steps:
  #     - attach_workspace:
  #         at: ./
  #     - run:
  #         name: Install AWS CLI
  #         command: pip install awscli --upgrade --user
  #     - run:
  #         name: Download epages-docs
  #         command: |
  #           ~/.local/bin/aws s3 sync s3://$S3_BUCKET_NAME ./_site --exclude "about/*" \
  #                                                                 --exclude "api/*" \
  #                                                                 --exclude "beyond-essence/*" \
  #                                                                 --exclude "blog/*" \
  #                                                                 --exclude "devjobs/*" \
  #                                                                 --exclude "api/*" \
  #                                                                 --exclude "assets/css/*" \
  #                                                                 --exclude "assets/fonts/*" \
  #                                                                 --exclude "assets/img/*" \
  #                                                                 --exclude "assets/js/*" \
  #                                                                 --exclude "assets/slick/*" \
  #                                                                 --exclude "404.html" \
  #                                                                 --exclude "index.html"
  #     - run:
  #         name: Deploy to S3
  #         command: ~/.local/bin/aws s3 sync ./_site s3://$S3_BUCKET_NAME/ --size-only --delete --acl public-read
  #
  #     - persist_to_workspace:
  #         root: ./
  #         paths:
  #           - ./_site
  #           - ./.firebaserc
  #           - ./firebase.json

workflows:
  version: 2
  build_test_deploy:
    jobs:
      # - dependencies
      # - build:
      #     requires:
      #       - dependencies
      # - test_html:
      #     requires:
      #       - build
      # - test_files:
      #     requires:
      #       - build
      # - test_posts:
      #     requires:
      #       - build
      - download_docs:
          # requires:
          #   - test_html
          #   - test_files
          #   - test_posts
          filters:
            branches:
              only: staging
      # - deploy_firebase:
      #     requires:
      #       - deploy_aws
      #     filters:
      #       branches:
      #         only: master
      #
